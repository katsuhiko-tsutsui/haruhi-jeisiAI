<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>HARUHI ãƒãƒ£ãƒƒãƒˆUI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
  .main-container {
    display: flex;
    height: 100vh;
  }
  .sidebar {
    width: 15%;
    background-color: #f0f0f0;
    overflow-y: auto;
    padding: 10px;
    border-right: 1px solid #ccc;
  }
  .chat-area {
    flex: 1;
    position: relative;
    overflow-y: auto;
    padding: 20px;
  }

  /* âœ… è¿½åŠ ï¼šãƒ©ãƒ³ãƒãƒ£ãƒ¼ç”»åƒå›ºå®š */
  #sakura-faq-popup-launcher {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    cursor: pointer;
  }
</style>
</head>
<body>
  <div class="main-container">
    <div class="sidebar">
      {% include '_chat_sessions.html' %}
  </div>
    <div class="chat-area">
      {% include '_chat_content.html' %}
    </div>
  </div>
</body>
<!-- FAQãƒ©ãƒ³ãƒãƒ£ãƒ¼ç”»åƒ -->
  <div id="sakura-faq-popup-launcher" onclick="toggleFaqIframe()">
    <img src="{{ url_for('static', filename='img/sakura_popup.png') }}" alt="FAQã‚’è¦‹ã‚‹" style="width: 200px;" />
  </div>

<!-- âœ… FAQãƒãƒƒãƒ—iframe -->
  <iframe id="faqPopupIframe"
        src="/faq_popup"
        style="
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 95vh;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 9999;
            display: none; /* æœ€åˆã¯éè¡¨ç¤º */
        ">
  </iframe>
<!-- toggleé–¢æ•° -->
  <script>
  function toggleFaqIframe() {
    const iframe = document.getElementById("faqPopupIframe");
    const isVisible = iframe.style.display === "block";
    iframe.style.display = isVisible ? "none" : "block";
  }
  function toggleFaqIframe() {
    const iframe = document.getElementById("faqPopupIframe");
    const isVisible = iframe.style.display === "block";
    iframe.style.display = isVisible ? "none" : "block";
  }

  // âœ… è¦ªwindowãŒiframeã‹ã‚‰ã€Œcloseã€å‘½ä»¤ã‚’å—ã‘å–ã‚‹ãƒªã‚¹ãƒŠãƒ¼
  window.addEventListener("message", (event) => {
    if (event.data === "closeFaqPopup") {
      toggleFaqIframe();
    }
  });
</script>

<script>
  // HARUHIãƒãƒ£ãƒƒãƒˆï¼šæœ€å¾Œã®ç™ºè¨€ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆGPTé¢¨ï¼‰
  function scrollToLastMessage() {
    const lastMessage = document.getElementById("last-message");
    if (lastMessage) {
      lastMessage.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  }

  window.addEventListener('load', () => {
    setTimeout(scrollToLastMessage, 300);  // ãƒšãƒ¼ã‚¸å†æç”»å¾Œã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  });
</script>
<script>
  // ğŸŒ¸ HARUHI - æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆã¨åˆ‡ã‚Šæ›¿ãˆ
  let session_id = generateSessionId();  // åˆæœŸ session_idï¼ˆç”»é¢èª­ã¿è¾¼ã¿æ™‚ï¼‰

  document.addEventListener('DOMContentLoaded', () => {
    const newChatBtn = document.getElementById('new-chat-btn');
    if (newChatBtn) {
      newChatBtn.addEventListener('click', () => {
        // âœ… ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
        const chatLog = document.getElementById('chat-log-content');
        if (chatLog) {
          chatLog.innerHTML = '';
        }

        // âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’æ–°ãŸã«ç”Ÿæˆ
        session_id = generateSessionId();

        // âœ… GETãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ç”¨ï¼‰ã® hidden input ã‚’æ›´æ–°
        const sessionInput = document.querySelector('input[name="session_id"]');
        if (sessionInput) {
          sessionInput.value = session_id;
        }

        // âœ… POSTãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ç”¨ï¼‰ã® hidden input ã‚’æ›´æ–°
        const sessionInputPost = document.getElementById('session_id_input_post');
        if (sessionInputPost) {
          sessionInputPost.value = session_id;
        }

        // âœ… ãƒ•ã‚©ãƒ¼ãƒ ã® action URL ã«æ–°ã—ã„ session_id ã‚’ä»˜ä¸
        const chatForm = document.querySelector('form[action^="/chat_ui/"]');
        if (chatForm) {
          chatForm.action = `/chat_ui/guest?session_id=${session_id}`;
        }

        // âœ… ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
        console.log("ğŸ†• æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹:", session_id);
      });
    }
  });

  // ğŸŒ¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆé–¢æ•°
  function generateSessionId() {
    const timestamp = new Date().toISOString().replace(/[-:T.]/g, '').slice(0, 14);
    const randomPart = Math.random().toString(36).substring(2, 8);
    return `session-${timestamp}-${randomPart}`;
  }
</script>

</html>